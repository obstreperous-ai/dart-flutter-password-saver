name: Dependency Security Scan

on:
  push:
    branches: [ main, master, develop ]
  pull_request:
    branches: [ main, master, develop ]
  schedule:
    # Run weekly on Monday at 00:00 UTC
    - cron: '0 0 * * 1'

jobs:
  dependency-scan:
    name: Scan Dependencies for Vulnerabilities
    runs-on: ubuntu-latest
    
    permissions:
      contents: read
      security-events: write
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Set up Flutter
        uses: subosito/flutter-action@v2
        with:
          channel: 'stable'
          cache: true
      
      - name: Get dependencies
        run: flutter pub get
      
      - name: Run dependency audit
        run: |
          echo "=== Dependency Audit Report ==="
          echo ""
          echo "Checking for known vulnerabilities in dependencies..."
          flutter pub outdated --json > outdated.json || true
          if [ -f outdated.json ]; then
            echo "✓ Dependency information collected"
            
            # Pretty print dependency information
            echo ""
            echo "=== Outdated Dependencies ==="
            flutter pub outdated || true
          fi
      
      - name: Check for security advisories
        run: |
          echo ""
          echo "=== Security Advisory Check ==="
          echo "Note: Dart/Flutter doesn't have a built-in security audit tool like npm audit"
          echo "Please review dependencies manually at https://pub.dev"
          echo ""
          echo "=== Direct Dependencies ==="
          flutter pub deps --style=compact 2>&1 | head -50 || echo "Unable to list dependencies"
          
          # List all dependencies with versions
          echo ""
          echo "=== Installed Package Versions ==="
          flutter pub deps --no-dev | grep -E "^[├└]" || true
      
      - name: Check dependency constraints
        run: |
          echo ""
          echo "=== Dependency Constraint Analysis ==="
          
          # Check if dependencies are pinned appropriately
          if grep -E "any|>=.*<999" pubspec.yaml; then
            echo "⚠ Warning: Found loose version constraints"
            echo "Consider using more specific version constraints"
          else
            echo "✓ Dependency version constraints look reasonable"
          fi
      
      - name: Upload dependency information
        uses: actions/upload-artifact@v4.4.3
        with:
          name: dependency-report
          path: outdated.json
          if-no-files-found: ignore
      
      - name: Summary
        if: always()
        run: |
          echo ""
          echo "=== Dependency Scan Summary ==="
          echo "✓ Dependency information collected and uploaded"
          echo "✓ Review the job output for any warnings"
          echo ""
          echo "For detailed security information, visit:"
          echo "  - https://pub.dev/packages/flutter_secure_storage/versions"
          echo "  - https://pub.dev/packages/encrypt/versions"
          echo "  - https://pub.dev/packages/path_provider/versions"
